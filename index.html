<!doctype html>


<head>
<meta charset="utf-8" />
<!--<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:200,400,700,900" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">-->

<!--
font-family: 'VT323', monospace;
font-family: 'Princess Sofia', cursive;
font-family: 'Indie Flower', cursive;
font-family: 'Dokdo', cursive;
font-family: 'East Sea Dokdo', cursive;
font-family: 'Creepster', cursive;
font-family: 'Bungee Hairline', cursive;
font-family: 'Bungee', cursive;
font-family: 'Bungee Shade', cursive;
font-family: 'Bungee Inline', cursive;
font-family: 'Cormorant Garamond', serif;
-->

<!-- todo: strip and remove the unused -->
<link href="https://fonts.googleapis.com/css?family=Schoolbell|Dokdo|Fira+Sans:300,800,900" rel="stylesheet">

<link href="css/animate.css" rel="stylesheet" type="text/css">
<script src="js/lodash.min.js"></script>
<script src="js/d3.v5.min.js"></script>
<script src="js/d3-array.v2.min.js"></script>

<script src="js/vue.js"></script>
<script src="js/vuex.js"></script>

<script src="js/jquery-1.9.1.js"></script>

<script src="js/utils.js"></script>

<style>

text{
  font-size: 13px;
/*  font-family: 'Schoolbell', cursive;*/
}

*{
  font-family: 'Fira Sans', sans-serif;
  font-size: 18px;
  font-weight: 300;
}

ul{
  list-style-type:none;    
}
div{
  margin-bottom: 16px;
}

.normal-div, .normal-div div{
  margin-bottom: 0px;
}
/* font-family: 'Gaegu', cursive; -- cute child like handwriting */
/* font-family: 'Dokdo', cursive; -- funky */
/* font-family: 'Bungee Shade', cursive; -- pop art caps */
ul{
  margin-top: 0px;
}
h4{
  font-size: 18px;
  font-weight: 500;
}
a{
  color: #337ab7; /* boostrap blue */
  text-decoration: none;
  cursor: pointer;
}
img{
  max-width: 400px;
}
.handwriting, .handwriting *{
/* font-family: 'Dokdo', cursive; */   
  font-family: 'Schoolbell', cursive;
}
.dialog-text, .dialog-text *{
/*  font-family: 'Dokdo', cursive;  */
  font-family: 'Schoolbell', cursive;
  font-size: 28px;
  width: 340px;
}
.small-dialog-text, .small-dialog-text *{
/*  font-family: 'Dokdo', cursive;  */
  font-family: 'Schoolbell', cursive;
  font-size: 20px;
}
.centered, .centered *{
  font-size: 22px;
}
button{
  cursor: pointer;
  background-color: white;
  border-radius: 4px;
  font-size: 28px;
  font-weight: 900;
  margin-bottom: 8px; 
  padding: 8px 16px;
  margin: 8px;
}
.question button:hover, .question .clicked-button{
  color: white;
  background-color: black;
}
.bold{
  font-weight: 900;
}
.centered{
  display: grid;
  grid-template-columns: 1fr 500px 1fr;
  grid-template-rows: 1fr auto 1fr;
  grid-template-areas: 
    ". . ."
    ". centered-content ."
    ". . .";
  height: 500px;
}
.centered-content {
  grid-area: centered-content;
}
.centered button{
  margin: 0 auto;
  margin-bottom: 8px;
}
.hidden-at-first{
  opacity: 0;
  transition: opacity 1s;
}
.spin-and-pulse{
  position: absolute;
  animation: spin-and-pulse 5s ease 0s 1;
}
@keyframes spin-and-pulse {
  0% {
    transform: rotate(1turn);
  }
  5% {
    transform: rotate(0turn);
  }
  7% {
    transform: scale(1);
  }
  10% {
    transform: scale(1.2);
  }
  13% {
    transform: scale(1);
  }
  15% {
    transform: scale(1.1);
  }
  18% {
    transform: scale(1);
  }
}
.wobble{
  position: absolute;
  animation: wobble 5s ease 0s infinite;
}
@keyframes wobble {
  0% {
    transform: rotate(0turn);
  }
  5% {
    transform: rotate(0.003turn);
  }
  10% {
    transform: rotate(0turn);
  }
  12% {
    transform: rotate(0.003turn);
  }
  15% {
    transform: rotate(0turn);
  }
}
.bounce{
  position: absolute;
  animation: bounce 5s ease 0s infinite;
}
@keyframes bounce {
  0% {
    transform: translateY(20px);
  }
  3% {
    transform: translateY(-30px);
  }
  6% {
    transform: translateY(10px);
  }
  10% {
    transform: translateY(-10px);
  }
  12% {
    transform: translateY(0px);
  }
}
@keyframes mad-bounce {
  0% {
    transform: translateY(20px);
  }
  1% {
    transform: translateY(-30px);
  }
  2% {
    transform: translateY(10px);
  }
  3% {
    transform: translateY(-10px);
  }
  4% {
    transform: translateY(0px);
  }
}
.mad-bounce{
  position: absolute;
  animation: bounce 4s ease 0s infinite;  
}
.walk-drift{
  position: absolute;
  transition: left 3s;
}
.walk-bounce{
  position: absolute;
  animation: walk-bounce 0.8s ease 0s infinite;
}
@keyframes walk-bounce {
  0% {
    transform: translateY(0px);
  }
  25%{
    transform: translateY(-12px);    
  }
  50% {
    transform: translateY(0px);
  }
  75%{
    transform: translateY(-12px);    
  }
  100% {
    transform: translateY(0px);
  }
}
@keyframes fallover{
  100% {
    transform: rotate(0.3turn);
  }
}
.fallover{
  position: absolute;
  animation: fallover 1s ease-in 0s 1; /* to not stand back up:  normal forwards;  */
}
.point-container{
  width: 350px;
  display:flex; 
  justify-content:space-between; 
  margin: 0 auto;
}
.point{
  display: inline-block;
  width: 12px;
  height: 12px;
/*  border-radius: 50%;*/
  border: 2px solid black;
  margin-top: 4px;
  transition: all .5s ease;
}
.active-point{
  background-color: black;
  width: 20px;
  height: 20px;
  margin-top: 0px;
}
.circle{
  border-radius: 50%;
  width: 14px;
  height: 14px;
}
.circle.active-point{
  width: 20px;
  height: 20px;  
}
:not(.circle).active-point{
  width: 18px;
  height: 18px;
  margin-top: 1px;
}


.point:hover{
  background-color: #333;
}
.has-tooltip{
  position: relative;
}
.has-tooltip span{
  display: none;
  position:absolute;
  font-size: 10px;
  top: 24px;
  white-space: nowrap;
  background-color: rgba(0,0,0,0.5);
  padding: 8px;
  border-radius: 8px;
  color: white;
}
.has-tooltip:hover span{
  display: inline-block;
}
.extra-info, .extra-info *{
/*  font-size: 14px;*/
}
.smaller-children, .smaller-children *{
  font-size: 16px;
}
/* https://w3bits.com/rainbow-text/ */
.rainbow-text {
  background-image: repeating-linear-gradient(45deg, violet, indigo, blue, green, orange, red, violet);
  text-align: center;
  background-size: 800% 800%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: rainbow 4s ease infinite;
}
@keyframes rainbow { 
    0%{background-position:0% 50%}
    50%{background-position:100% 25%}
    100%{background-position:0% 50%}
}
.fade-enter-active, .fade-leave-active {
  transition: opacity 1s;
}
.fade-enter, .fade-leave-to {
  opacity: 0;
}
.slide-fade-enter-active, .slide-fade-leave-active {
  transition: all .3s ease;
}
.slide-fade-enter, .slide-fade-leave-to {
  transform: translateY(-300px);
  opacity: 0;
}
.story-point-silhouette{
  -webkit-filter: contrast(0%) brightness(50%);
  filter: contrast(0%) brightness(50%);
  cursor: pointer;
}
.story-point-silhouette:hover{
  -webkit-filter: none;
  filter: none;
}
.cropcircle{
    width: 100px;
    height: 100px;
    border-radius: 100%;
/*    background: #000 no-repeat center;*/
    background-size: cover;
    border: 4px solid black;
}

.small-avatar{
  width: 80px;
}
.coin{
  display: inline-block;
  width:100px;
  cursor: pointer;
  vertical-align: top;
  word-wrap: break-word;

  -webkit-user-select: none; /* Safari 3.1+ */
  -moz-user-select: none; /* Firefox 2+ */
  -ms-user-select: none; /* IE 10+ */
  user-select: none; /* Standard syntax */
}

/* https://forum.vuejs.org/t/add-transitions-to-slide-up/27446/4 */
.slide-up-enter-active {
  transition: all .6s ease;
}
.slide-up-leave-active {
  transition: all .6s cubic-bezier(1.0, 0.5, 0.8, 1.0);
}
.slide-up-enter, .slide-fade-leave-to {
  transform: translateY(100vh);
  opacity: 0;
}
.nope{
  color:red; 
  font-size: 14px; 
}

</style>

<body>



<div id="app" style="position:relative;left: 60px;width:calc(100% - 60px); height:calc(100vh - 200px)">
  <div style="width:60px;background-color: #eee; position: fixed; top:0px; left:0px; padding: 4px; height: 100%;">
    <div v-for="(storyPoint, ind) in storyPoints"
         @click="storyPointInd = ind"
         class="has-tooltip"
         style="display:inline-block;">
      <img :class="{'story-point-silhouette': currentStoryPoint !== storyPoint}"
          :src="'images/' + storyPoint.image" 
          style="width:50px">
      <span style="top:60px;">{{storyPoint.name}}</span>
    </div>
  </div>
<!--
<transition name="slide-fade">
<div v-if="show" style="background-color: blue; width:200px; height:200px;"></div>
</transition>
  <button @click="show = !show">
    Toggle render
  </button>
<button class="rainbow-text">Test</button>
<story :visible="true">
Are you here?
If so, you are in the <a @click="show('waiting')">right place</a>.
What is the probability that you will succeed?
</story>
<once-group>
<once-button>1/2</once-button>
<once-button>1/4</once-button>
<once-button>1/8</once-button>
</once-group>
<story ref="waiting">
I have been <a @click="show('changing')">waiting</a> for you. 
</story>
<story ref="changing">
The times are changing.
The prophecies are unclear, but the times are changing.
This planet is <a @click="show('new-world')">changing</a>.
</story>
<story ref="new-world">
<div>
You are going to bring us into this new world of <span class="animated infinite jello" style="display:inline-block">uncertainty</span>.
</div>-->


<!-- <div style="width: 150px; position:absolute; left: 0px; text-align: left; padding-left: 16px">
  <div v-for="storyPoint in storyPoints"
      @click="currentStoryPoint = storyPoint"
      style="margin-bottom: 4px;"
      :style="storyPointStyle(storyPoint)">
    <a :class="[storyPoint === currentStoryPoint ? 'active-tab': 'inactive-tab']">{{storyPoint.name}}</a>
  </div>
</div> -->


<keep-alive>
  <component v-bind:is="currentStoryPoint.component"></component>
</keep-alive>



</div> <!-- end #app -->

<script type="text/x-template" id="note-template">
<span style="position:relative; top:6px; text-align:center; display:inline-block" class="normal-div">
  <div><slot></slot></div>
  <div class="handwriting" style="font-size:10px; white-space:nowrap;">{{title}}<slot name="title"></slot></div>
</span>
</script>

<script type="text/x-template" id="glitch-template">
  <div>
    <img v-if="showStart" :src="'images/'+start" style="width:100%">
    <img v-if="!showStart" :src="'images/'+end" style="width:100%">
  </div>
</script>

<script type="text/x-template" id="intro-scene-template">
<div style="width:600px; margin: 0 auto;">

<div key="intro"
  v-if="show('intro')">
<div class="handwriting" style="font-size:48px; text-align:center">The Great Statistics Mystery</div>


<div>
In a distant and serene land, knowledge of statistics and probability was widespread. The people were kind and loving. 
</div>

<div>
Until one day, a Bad Wizard set out to ruin probability for everyone. He would tamper with its mechanics. And terrorize the citizens. 
</div>

<div>
You have been chosen to join the Statistics Police. You are the final line of defense for holding the bad forces in check. 
</div>

<div>
The characters you gotta know:
</div>

<div>
<img src="images/cop.png" class="small-avatar"> <bold>Commando Gauss</bold> — Here to show you the ropes. A veteran of the Statistics Police. A bit of a hardass.
</div>

<div>
<img src="images/wizard.png" class="small-avatar"> <bold>Bad Wizard</bold> — Causes damage that you have to undo. Likes mischief. Motives not yet known.
</div>

<buton @click="set('1')">Play</buton>
</div>

<avatar key="1"
  v-if="show('1')"
  image="cop.png"
  text="Hey! You're the new trainee, right?">
  <buton @click="set('2')">Er...</buton>
  <buton @click="set('2')">Yes</buton>

</avatar>


<avatar key="2"
  v-if="show('2')"
  image="cop.png"
  text="I still remember my first day with the Statistics Police... What an honor to be chosen to help people with their statistics problems.">
  <buton @click="set('3')">Next</buton>
</avatar>


<avatar key="3"
  v-if="show('3')"
  image="cop.png"
  text="I'm going to make a fine officer out of you. Let's head to headquarters and see if anyone needs help.">
  <buton @click="$root.nextStory()">To headquarters</buton>
</avatar>


</div>
</script>

<script type="text/x-template" id="cut-scene-template">
<div style="width:700px; height:200px; margin-bottom: 100px; position:relative; margin:0 auto;" class="normal-div" >

  <div v-if="showCop" style="position:absolute; bottom:0px; left:0px;" ref="cop">
    <img src="images/cop.png" style="width:100px" >

    <span v-if="showExclamation" style="font-size:48px; position:absolute; bottom:110px; left:50px">!</span>

    <div v-if="showDialog" style="position:absolute; width:340px; left: 100px; top:20px;">
      <img src="images/dialog.png" style="width:340px; height:100px;">

      <live-text ref="cop-dialog" :key="state" class="handwriting" style="position:absolute; left:24px; top:8px;" @live-text-complete="liveTextComplete()">
        {{copDialog}}
      </live-text>
    </div>
  </div>

  <div v-if="showButons" style="position:absolute; left: 450px; bottom:0px">
    <buton v-for="butonValue in butonValues" :key="butonValue" @click="advance()">{{butonValue}}</buton>
  </div>

  <img v-if="showWizard" 
    ref="wizard" :src="'images/' + wizardImg" class="walk-drift" style="width:100px;position:absolute;left:0px;z-index:-1">

  <glitch ref="monster" v-if="showMonster" start="monster.png" end="monster.png" style="width:80px; position:absolute; left: 200px;bottom:0px;" ></glitch>

  <glitch ref="girl" v-if="showMonster" start="girl.png" end="girl_fuzzy.png" style="width:80px; position:absolute; left: 280px;bottom:0px;" ></glitch> 

  <div style="position:absolute; bottom:-100px; margin: 32px;">
    <live-text :key="narration">
      {{narration}}
    </live-text>
  </div>
</div>
</script>

<script type="text/x-template" id="coin-flips-template">
<div>

<!-- jump to a diferent problem -->
<div class="point-container">
  <div v-for="point in points" 
  @click="set(point.key)" 
  class="point has-tooltip" 
  :class="pointClass(point)"
  :style="pointStyle(point)">
    <span>{{point.name}}</span>
  </div>
</div>

<centered key="intro"
  v-if="show('intro')" style="text-align:center;">

  <img src="images/monster.png" style="width:200px;">

  <div>
    A curious green creature walks into the statistics police headquarters.
  </div>

  <buton @click="set('something-wrong')">Talk</buton>

</centered>

<!-- <transition name="fade" mode="out-in">-->
<avatar key="something-wrong"
  v-if="show('something-wrong')"
  image="monster.png"
  text="I think something is wrong with my coins. I wonder if this is the Bad Wizard's doing?">
  <buton @click="set('50-50')">What's wrong?</buton>
</avatar>

<avatar key="50-50"
  v-if="show('50-50')"
  image="monster.png" 
  text="You know how when you toss a fair coin, it's supposed to land H with 50% probability? And T with 50% probability?">
  <buton @click="set('HH')">Yeah</buton>
</avatar>

<avatar key="HH"
  v-if="show('HH')"
  image="monster.png" 
  text="What is the probability that I toss a fair coin twice and get HH?">
  <buton nope="1/2 is the probability of tossing a single coin and getting H. Getting two heads in a row is rarer than that.">1/2</buton>
  <buton @clik="set('HH-explanation')" yay>1/4</buton>
  <buton nope="Assume it is a fair coin that lands on heads with 50% probability.">Not enough info</buton>
</avatar>

<interstitial 
  key="HH-explanation" 
  v-if="show('HH-explanation')">
  <div>
    Yeah! The probability of multiple independent events all occuring can be calculated by multiplication. This is called the probability of the <bold>joint event</bold>. So, the chance of getting HH is 1/2 x 1/2.
  </div>

  <div>
    Another way to see this is that there are 4 possible outcomes:

    <div style="margin-top:16px">
    HH<br>
    HT<br>
    TH<br>
    TT<br>
    </div>

    If we only care about the HH outcome, our probability of getting it is 1/4.
  </div>
  <buton @click="set('HHH')">Next</buton>
</interstitial> 

<avatar key="HHH"
  v-if="show('HHH')"
  image="monster.png" 
  text="What is the probability that I toss a coin three times and get HHH?">
  <buton nope>1/2</buton>
  <buton nope>1/3</buton>
  <buton @clik="set('10H')" yay>1/8</buton>
  <buton nope>Not enough info</buton>

  <template v-slot:hint>
    <div>
      By the same logic as before, coin flips are independent events (i.e. a result doesn't affect the next result). The probabilities of the joint event: seeing X AND Y can be combined with multiplication. The chance of getting HHH is 1/2 x 1/2 x 1/2.
    </div>

    <div>
      Another way to see this is that there are 8 possible outcomes:

      HHH
      HHT
      HTH
      HTT
      THH
      THT
      TTH
      TTT

      If we only care about the HHH outcome, our probability of getting it is 1/8.
    </div>
  </template>
</avatar>


<avatar key="10H"
  v-if="show('10H')"
  image="monster.png" 
  text="What is the probability that I toss a coin 10 times and get HHHHHHHHHH?">
  <buton @clik="set('10HT')" yay>1/<exp base="2" pow="10"/></buton>
  <buton nope>1/2</buton>
  <buton nope>1/10</buton>
  <buton nope>1/20</buton>
  <buton nope>Not enough info</buton>

  <template v-slot:hint>
    <div>
      Remember that independent events can be combined with multiplication.
    </div>

    <div>
      So the chance of getting HHHHHHHHHH is ....

      (big fraction) approx .01%
    </div>
  </template>
</avatar>


<avatar key="10HT"
  v-if="show('10HT')"
  image="monster.png" 
  text="What is the probability that I toss a coin 10 times and get HHHTHHTTTT?">
  <buton @clik="set('10HT-interstitial')" yay>1/<exp base="2" pow="10"/></buton>
  <buton nope>1/2</buton>
  <buton nope>1/10</buton>
  <buton nope>1/20</buton>
  <buton nope>Not enough info</buton>
</avatar>

<!-- stopped here: thinking how to phrase this

  <avatar key="10HT"
  v-if="show('10HT')"
  image="monster.png" 
  text="How many different possible outcomes are there for tossing a coin 10 times?">
  <buton @clik="set('10HT-interstitial')" yay>10</buton>
  <buton nope>11</buton>
  <buton nope>20</buton>
  <buton nope>1024</buton>
</avatar> -->

<interstitial 
    image="monster.png"
    key="10HT-interstitial" 
    v-if="show('10HT-interstitial')">
  <div>
    Yeah! The chance of getting HHHTHHTTTT is the same as the probability of getting HHHHHHHHHH.
  </div>

  <div>
    Because both involve computing the probability of 10 independent coin flips.
  </div>

  <buton @click="set('HHHHH')">Next</buton>
</interstitial>


<avatar key="HHHHH"
  v-if="show('HHHHH')"
  image="monster.png" 
  text="If I tossed a fair coin 5 times, and it landed HHHHH all five times... What is it more likely to land the 6th time?">

  <template v-slot:hint>
    <div v-if="memory == 'userSaidT'">
      <div>Nope, that's the Gambler's Fallacy... a common misconception that events that haven't occured are more likely to occur.</div>

      <div>Coins have no memory, so just because H came up a lot, doesn't mean that T is more likely to come up in the future.</div>
    </div>

    <div v-if="memory == 'userSaidH'">
      <div>Nope, that's the Hot Hand Fallacy... a common misconception that events that have occurred recently are "hot" and more likely to come up.</div>

      <div>Coins have no memory, so just because H came up a lot, doesn't mean that H is any more likely to come up in the future.</div>
    </div>

  </template>


  <buton @click="memory='userSaidH'" nope>H</buton>
  <buton @click="memory='userSaidT'" nope>T</buton>
  <buton @clik="set('HHHHH-finale')" yay>It's 50-50</buton> <!-- needed to use clik, so rainbow would show -->
</avatar>

<avatar key="HHHHH-finale"
  v-if="show('HHHHH-finale')"
  image="monster_yay.png" 
  sound="right"
  text="Yeah! The correct answer is that it's 50-50, regardless of what has happened before since coins have no memory.">
  <buton @click="set('independence')">Next</buton>
</avatar>

<interstitial 
    image="monster.png"
    key="independence" 
    v-if="show('independence')">
  <div>
    Coin flips are <bold>independent events</bold>.
  </div>

  <div>
    Meaning that knowing the result of one event does not give you information about the other events. 
  </div>

<!--Which of these is another example of an independent event?
  <buton nope>Landing a job</buton>
  <buton @click="set('HH')" yay>Rolling dice</buton>
  <buton nope>Winning at games</buton>
  <buton nope>Having a good day</buton> -->

  <buton @click="set('100H')">Next</buton>

</interstitial>

<avatar key="100H"
  v-if="show('100H')"
  image="monster.png" 
  text="After I ran into the Bad Wizard the other day, I tossed a coin 100 times and it landed heads all 100 times! What do you think it landed on the 101-st time?">

  <buton-group :onClick="() => set('100H-result')">
    <buton yay>H</buton>
    <buton>T</buton>
    <buton>It's 50-50</buton>
  </buton-group>
</avatar>

<avatar key="100H-result"
  v-if="show('100H-result')"
  image="monster.png">

  <template v-slot:dialog>
   {{got('100H') ? 'Yeah!': 'Not quite.'}} The probability of 100 heads in a row on a fair coin is 1/2^100. If all the 2^80 atoms in the universe were flipping coins, this still probably wouldn't happen. That's why I think the Bad Wizard did something to my coins, and they are no longer fair.
 </template>

 <buton @click="set('quest')">I see</buton>
</avatar>


<avatar key="quest"
  v-if="show('quest')"
  image="monster.png" 
  text="Will you please track down the Bad Wizard and fix my coins?">


  <div style="font-size: 48px; letter-spacing:4px;">
  CONGRATS
  </div>

  <ul>
    <li>You learned about <bold>independent events</bold></li>
    <li>You learned to calculate the <bold>joint probability</bold> of independent events.</li>
    <li>You learned that there are <exp base="2" pow="80"/> atoms in the universe.</li>
  </ul> 


  <buton @click="$root.nextStory()">Accept Quest</buton>
</avatar>

<!-- </transition> -->

</div>
</script>

<script type="text/x-template" id="wizard-flips-template">
<div>

<!-- jump to a diferent problem -->
<div class="point-container" style="width: 250px">
  <div v-for="point in points" 
  @click="set(point.key)" 
  class="point has-tooltip" 
  :class="pointClass(point)"
  :style="pointStyle(point)">
    <span>{{point.name}}</span>
  </div>
</div>

<avatar key="intro"
  v-if="show('intro')"
  image="wizard.png" 
  text="Did somebody say my name?">
  <buton @click="set('wizard2')">Oops</buton>
</avatar>

<avatar key="wizard2"
  v-if="show('wizard2')"
  image="wizard.png" 
  text="Oh ho! You've noticed that coins have become unfair, have you? Let's see how you do at my new little game.">

  <buton @click="set('3coins')">Next</buton>
</avatar>

<avatar key="3coins"
  v-if="show('3coins')"
  image="wizard.png" 
  text="I have 3 coins. 2 are fair, 1 is unfair. Let's see if you can find the unfair one.">

  <div>Click the coins to flip them.</div>
  <div>When you have enough info, submit your guess.</div>

  <coin></coin>
  <coin></coin>
  <coin :bias="0.7"></coin>

  <div class="handwriting">The unfair coin is:</div>
  <div>
    <buton nope>A</buton>
    <buton nope>B</buton>
    <buton yay @click="set('interactive')">C</buton>
  </div>

  <template v-slot:hint>
    Hint: One coin has a tendency to land on one side more than the other.
  </template>
</avatar>

<avatar key="interactive"
  v-if="show('interactive')"
  image="wizard.png" >

  <template v-slot:dialog>
    {{ perfect('3coins') ? 'Oh. You got me. That coin was biased to land on H, 70% of the time.' : "HAAAHHAA! It's pretty hard to find the biased coin, right? And that was when the coin was biased to land on H, 70% of the time!"}} Wanna play with my awesome coin biasing machine?
  </template>

  <biased-coin-machine></biased-coin-machine>
  <buton @click="set('3coins2')">Done with this</buton> 

</avatar>

<avatar key="3coins2"
  v-if="show('3coins2')"
  image="wizard.png" 
  text="HAHA this is fun. I again have 3 coins. 2 are fair, 1 is unfair. Find the unfair coin.">

  <div>Click the coins to flip them.</div>
  <div>When you have enough info, submit your guess.</div>

  <coin></coin>
  <coin pattern="haha"></coin>
  <coin></coin>

  <div class="handwriting">The unfair coin is:</div>
  <buton nope>A</buton>
  <buton yay @click="set('3coins2-result')">B</buton>
  <buton nope>C</buton>

  <template v-slot:hint>
    Hint: The wizard may be having a joke at your expense.
  </template>

</avatar>


<avatar key="3coins2-result"
  v-if="show('3coins2-result')"
  image="wizard.png" 
  text="HAHA yes, that coin always says HAHA. It lands on heads 50% of the time, but it's unfair because I know what's coming next. Genius, isn't it??">

  <buton @click="set('3coins3')">Next</buton>
</avatar>


<avatar key="3coins3"
  v-if="show('3coins3')"
  image="wizard.png" 
  text="OKOK last one. Find the unfair coin.">

  <div>Click the coins to flip them.</div>
  <div>When you have enough info, submit your guess.</div>

  <coin></coin>
  <coin pattern="human"></coin>
  <coin></coin>

  <div class="handwriting">The unfair coin is:</div>
  <buton nope>A</buton>
  <buton yay @click="set('3coins3-result')">B</buton>
  <buton nope>C</buton>

  <template v-slot:hint>
    Hint: One of these coins is a bit shy.
  </template>
</avatar>


<avatar key="3coins3-result"
  v-if="show('3coins3-result')"
  image="wizard.png" 
  text="You got it. Interesting isn't it. This coin never has long streaks of one thing or the other. Humans tend to generate 'random' sequences like this. But they aren't random, because nature doesn't mind having long streaks.">

  <buton @click="set('fin')">Next</buton>
</avatar>


<avatar key="fin"
  v-if="show('fin')"
  image="wizard.png" 
  text="HAHAHA. That's it for coins. Literally childs play. If I can do this with coins, imagine what damage I can do with dice. Better level up quickly. You'll be seeing more of me. Toodooaloo~~">

  <div style="font-size: 48px; letter-spacing:4px;">
  CONGRATS
  </div>

  <ul>
    <li>You learned about what randomness feels like</li>
  </ul> 

  <buton @click="$root.nextStory()">Next Story</buton>
</avatar>

</div>
</script>

<script type="text/x-template" id="coin-template">
  <div @click="flip" class="coin normal-div">
    <img v-if="isShowingH" src="images/coin_heads.png" style="width:100px">
    <img v-if="!isShowingH" src="images/coin_tails.png" style="width:100px">
    <div ref="flip-string" style="font-size:13px;" :style="flipStringStyle">{{flipString}}</div>
    <histogram v-if="flips.length > 0" :hist="hist"></histogram>
  </div>
</script>



<script type="text/x-template" id="biased-coin-machine-template">
<div>
  <div>Adjust the bias, and click coin to flip.</div>
  <span>Lands H with {{$root.formatPct(bias)}} probability:</span>
  <input v-model="slider" type="range" min="0" max="100" style="width:200px">

  <div>
  <coin ref="coin" :bias="bias" style="width:300px"></coin>
  </div>
</div>
</script>


<script type="text/x-template" id="chain-rule-template">

<div>

<!-- jump to a diferent problem -->
<div class="point-container" style="width:400px">
  <div v-for="point in points" 
  @click="set(point.key)" 
  class="point has-tooltip" 
  :class="pointClass(point)"
  :style="pointStyle(point)">
    <span>{{point.name}}</span>
  </div>
</div>

<!--<transition name="fade" mode="out-in">-->

<avatar key="intro"
  v-if="show('intro')"
  image="girl.png" 
  text="Hello! I'm Veronica and I only date monsters that are tall and have great hair.">

  <buton @click="set('fakeout1')">Next</buton>
</avatar>


<avatar key="fakeout1"
  v-if="show('fakeout1')" 
  image="girl.png" 
  text="If 1/2 of all monsters are tall and 1/4 of monsters have great hair... What is the probability that a random monster is datable (i.e., is tall and has great hair)?">

  <div>
    In math language, P(tall) = 1/2. P(great hair) = 1/4. 
  </div>

  <div>
    What is P(tall AND great hair)?
  </div>

  <buton-group :onClick="() => set('fakeout1-inter')">
    <buton nope>1/8</buton>
    <buton nope="Hm... 1/3 doesn't make sense. Try again.">1/3</buton>
    <buton nope="Although 1/4 is the number of monsters have great hair, it's not clear that all great hair monsters are tall. Try again.">1/4</buton>
    <buton nope="There aren't even that many tall monsters! Try again.">3/4</buton>
    <buton yay>Not enough info</buton>
  </buton-group>

  <template v-slot:hint>
    Not quite. It is only valid to compute P(tall AND great hair) by multiplying P(tall) and P(great hair) if being tall and having great hair are <bold>independent</bold> — like coin flips.
  </template>

</avatar>


<interstitial 
    image="girl.png"
    key="fakeout1-inter" 
    v-if="show('fakeout1-inter')">

  <div>
    Right! It's not possible to say. 
  </div>

  <div>
    It is only valid to multiply two probabilities to calculate the joint probability if the two events are independent — like coin flips.
  </div>

  <div>
     In our case, <bold>independence</bold> occurs if a monster's height <bold>does not provide any information</bold> on the greatness of a monsters hair. 
  </div>

  <buton @click="set('conditional1')">Next</buton>
</interstitial>



<avatar key="conditional1" 
        v-if="show('conditional1')"
        image="girl.png" 
        text="It turns out that being tall and having great hair are slightly correlated, so they're not independent. I said before that 1/4 of all monsters have great hair. But about 1/3 of tall monsters have great hair.">

  <div>
    In math language, Veronica just told us a <bold>conditional probability</bold>. 
  </div>

  <div>
    Conditional probabilities are written like P(A|B). This indicates the probability of A, given that we know B to be true.
  </div>

  <div style="font-size:12px">
    Note: The "|" is pronounced as "given". 
  </div>

  <div>
    Veronica told us P(great hair|tall) = 1/3.
  </div>

  <div>
   The probability a monster has great hair is 1/3 <bold>given</bold> that we know the monster is tall. 
  </div>

  <div>
    We can use this information to calculate P(tall AND great hair).
  </div>

  <buton @click="set('conditional2')">Next</buton>
</avatar>


<interstitial 
    image="girl.png"
    key="conditional2" 
    v-if="show('conditional2')">

  <div>
    P(great hair|tall) = 1/3. A third of tall monsters have great hair. The probability that a tall monster has great hair is 1/3.
  </div>

  <div>
    We can use this to calculate P(tall AND great hair) without assuming independence.
  </div>

  <div>
    P(tall AND great hair) = P(tall) x P(great hair|tall)
  </div>

  <div>
    The formula makes logical sense. Multiply the fraction of tall monsters with the fraction of tall monsters with great hair.
  </div>

  <buton @click="set('tall-hair')">Try it</buton>
</interstitial>


<avatar key="tall-hair" 
        v-if="show('tall-hair')"
        image="girl.png" 
        text="Okay so what is the probability that a random monster is datable?">

  <div>What is P(tall AND greathair)?</div>

  <div class="extra-info">Facts from before:
  <ul>
    <li>P(tall) = 1/2</li>
    <li>P(great hair) = 1/4</li>
    <li>P(great hair | tall) = 1/3</li>
  </ul>
  </div>

  <buton-group :onClick="() => set('fakeout2')">
    <buton yay>1/6</buton>
    <buton nope="We said that being tall and having great hair are not independent, so we can't just multiply 1/2 x 1/4.">1/8</buton>
    <buton nope="Are you just multiplying things together? Try again.">1/24</buton>
    <buton nope="The answer isn't always 'Not enough info'...">Not enough info</buton>
  </buton-group>
</avatar>


<avatar key="fakeout2"
        v-if="show('fakeout2')"
        image="girl.png"
        text="Oh thank you for your help so far. But I forgot... I also want them to have tattoos. 1/5 of monsters have tattoos.">

  <div>In math speak, P(tattoos) = 1/5.</div>
  <div>What is P(tall AND great hair AND tattoos)?</div>

  <div class="extra-info">Facts from before:
    <ul>
      <li>P(tall) = 1/2</li>
      <li>P(greathair) = 1/4</li>
      <li>P(greathair|tall) = 1/3</li>
      <li>You calculated P(greathair AND tall) = 1/6</li>
    </ul>
  </div>

  <buton-group :onClick="() => set('chainruleinter1')">
    <buton coy>1/30</buton>
    <buton nope="Remember, we want to use P(greathair|tall), not P(tall).">1/40</buton>
    <buton nope="Wait, are you just blindly multiplying numbers? Stop that.">1/120</buton>
    <buton yay>Not enough info</buton>
  </buton-group>
</avatar>


<interstitial 
    image="girl.png"
    key="chainruleinter1" 
    v-if="show('chainruleinter1')">

  <div>
    {{ got('fakeout2') ? 'Right.': 'Not quite.' }} Again, it's not possible to say!
  </div>

  <div>
    To get P(tattoo AND great hair AND tall), we can't just multiply
    P(tattoo) * P(great hair AND tall) without assuming independence.
  </div>

  <div>
    We need another conditional probability.
  </div>

  <buton @click="set('chainruleinter2')">Next</buton>
</interstitial>

<interstitial 
    image="girl.png"
    key="chainruleinter2" 
    v-if="show('chainruleinter2')">
  <div>
    This is called the Chain Rule of probability.
  </div>

  <div class="smaller-children">
    P(tattoo AND greathair AND tall) = <br>
    <span style="color:magenta">P(tall)</span> * <span style="color:green">P(great hair | tall)</span> * <span style="color:blue">P(tattoo | great hair AND tall)</span>
  </div>

  <div class="smaller-children" style="margin-left: 16px;">
    <div>
      First, consider the <span style="color:magenta">probability of the monster being tall</span>.
    </div>

    <div>
      Then, consider the <span style="color:green">probability of a tall monster having great hair</span>.
    </div>

    <div>
      Then, consider the <span style="color:blue">probability that a tall monster with great hair, would have a tattoo</span>.
    </div>

    <div>
      Multiply together to get monsters that are tall and have great hair and have tattoos.
    </div>
  </div>

  <div>
    Basically, the Chain Rule says that when adding a new item to the joint probability, condition on all the events that already exist.
  </div>

  <buton @click="set('problem3')">Try it</buton>
</interstitial>


<avatar key="problem3" 
        v-if="show('problem3')"
        image="girl.png" 
        text="Ooh yes, I've heard of the Chain Rule. Here are the numbers that you'll need.">

  <template v-slot:hint>
    <div>
      Recall the Chain Rule says that everything must be conditioned on what came before. 
    </div>
    <div>
      So P(tall, greathair, tattoos) = P(tall) * P(greathair | tall) * P(tattoos | greathair AND tall). 
    </div>
  </template>

  <div>
  What is P(tall, greathair, tattoos)?
  </div>

  <div class="extra-info">
  Facts from before:
  <ul>
    <li>P(tall) = 1/2</li>
    <li>P(greathair) = 1/4</li>
    <li>P(greathair|tall) = 1/3</li>
    <li>P(tattoos) = 1/5</li>
    <li>P(tattoos|tall) = 1/6</li>
    <li>P(tattoos|tall AND greathair) = 1/7</li>
  </ul>
  </div>

  <div>
  P(tall, greathair, tattoos) =  1/<input-box :right="42" :onRight="() => set('problem4')"/>
  </div>

</avatar>


<avatar key="problem4" 
        v-if="show('problem4')"
        image="girl.png" 
        text="Yes, thank you! But silly us! We forgot to include that these tall, great hair, tattooed monsters also need to be... around my age and single.">

    <div class="extra-info">
    Facts from before:
    <ul>
      <li>P(tall) = 1/2</li>
      <li>P(greathair) = 1/4</li>
      <li>P(greathair|tall) = 1/3</li>
      <li>P(tattoos) = 1/5</li>
      <li>P(tattoos|tall) = 1/6</li>
      <li>P(tattoos|tall AND greathair) = 1/7</li>
      <li>P(around her age|tall AND greathair AND tattoos) = 1/5</li>
      <li>P(single|tall AND greathair AND tattoos AND around her age) = 1/2</li>
    </ul>
    </div>


    <template v-slot:hint>
      <div>
        Recall the Chain Rule says that everything must be conditioned on what came before. 
      </div>
      <div>
        So in the case of four events, P(tall, greathair, tattoos, single) = P(tall) * P(greathair | tall) * P(tattoos | greathair AND tall) * P(greathair AND tall AND tattoos | single). 
      </div>
      <div>
        What is it for five events?
      </div>
    </template>

    <div>
    P(tall, greathair, tattoos, around her age, single) =
    </div>

    1/<input-box :right="420" :onRight="() => set('not-many')"/>
</avatar>


<avatar key="not-many"
        v-if="show('not-many')"
        image="girl_shock.png" text="That's not very many people!">

  <div>
    Even though each individual criteria may not seem picky, requiring that a monster have all those traits leaves Veronica with a very small dating pool.
  </div>

  <div>
    But hey, at least Veronica's pickiness taught you the Chain Rule.
  </div>

  <buton @click="set('mind-blown')">Next</buton>
</avatar>

<interstitial 
    image="girl.png"
    key="mind-blown" 
    v-if="show('mind-blown')">
  <div>
    One quick thing that may blow your mind.
  </div>

  <div>
    We had been decomposing:
  </div>

  <div style="font-size:16px">
    P(tall AND greathair and tattoos) = P(tall) * P(greathair|tall) * P(tattoos | tall AND greathair).
  </div>

  <div>
    But notice... that we can also decompose it as:
  </div>

  <div style="font-size:16px">
    P(tall AND greathair and tattoos) = P(greathair) * P(tattoos | greathair) * P(tall | tattoos AND greathair).
  </div>

  <div>
    We can decompose it in any order we choose to, depending on what information we have on hand.
  </div>

  <div>
    How many different ways are there to decompose P(tall AND greathair and tattoos) using the Chain Rule?
  </div>
  <input-box :right="6" :onRight="() => set('congrats')" :feedback="true"/>
</interstitial>

<centered key="congrats"
  v-if="show('congrats')">
  <div style="font-size: 48px; letter-spacing:4px;">
  CONGRATS
  </div>
  
  <ul>
    <li>You learned about independence</li>
    <li>You learned about Chain Rule</li>
    <li>You learned to not be too picky ❤️</li>
  </ul> 

  <buton @click="finish()">Next section</buton>
</centered>

</transition>

</div>

</script>

<script type="text/x-template" id="risk-reward-template">
<div>

<!-- jump to a diferent problem -->
<div class="point-container" style="width:220px">
  <div v-for="point in points" 
  @click="set(point.key)" 
  class="point has-tooltip" 
  :class="pointClass(point)"
  :style="pointStyle(point)">
    <span>{{point.name}}</span>
  </div>
</div>


<!--<transition name="fade" mode="out-in">-->

<avatar key="intro"
  v-if="show('intro')"
  image="bear.png" 
  text="Do you dare play with a bear???">
  <buton @click="set('ev')">Yes</buton>
</avatar>

<avatar key="ev"
  v-if="show('ev')"
  image="bear.png" 
  text="What would you rather? (a) I pay you 1 coin or... (b) I pay you 4 coins with 20% certainty, and 80% of the time you get nothing.">
  <buton @click="set('ev-right')" yay>(a) 1 coin with certainty</buton>
  <buton @click="set('ev-wrong')" nope>(b) 4 coins with 20% certainty</buton>
</avatar>

<avatar key="ev-right"
  v-if="show('ev-right')"
  image="bear.png" 
  text="Well, that's correct.">

  <div>
   On average, the 4 coins with 20% probability is only worth 0.8 coins on average, so the 1 coin with certainty is worth more.
  </div>

  <buton @click="set('100')">Next</buton>
</avatar>

<avatar key="ev-wrong"
  v-if="show('ev-wrong')"
  image="bear_money.png" 
  text="Heh heh ."
  animation="spin-and-pulse">

  <template v-slot:overlay>
    <div>
      Player! Your answer was incorrect.
    </div>

    <div>
      On average, the 4 coins with 20% certainty is only worth 0.8 coins.
    </div>

    <div>
      AND it's riskier because the payout isn't guaranteed.
    </div>

    <div>
      By the risk-reward tradeoff, you ought to be compensated for extra risk with higher average reward.
    </div>

    <div style="font-size: 10px">
      The bear offered a bum deal because 4 coins with 20% probability was higher risk and lower average reward.
    </div>

    <buton @click="set('100')">Next</buton>
  </template>
</avatar>

<avatar key="100"
  v-if="show('100')"
  image="bear.png" 
  text="What if I offered you the chance to pick one choice and play 100 times? Which would you pick?">
  <buton @click="set('100-right');" yay>(a) 1 coin with certainty</buton>
  <buton @click="set('100-wrong')" nope>(b) 4 coins with 20% certainty</buton>
</avatar>


<avatar key="100-right"
  v-if="show('100-right')"
  image="bear.png" 
  text="Yeah, that's correct.">

  <div>
   Playing 100 times doesn't change the fact that 4 coins with 20% probability has the lower expected value.
  </div>

  <buton @click="set('100-chart')">Next</buton>
</avatar>

<avatar key="100-wrong"
  v-if="show('100-wrong')"
  image="bear_money.png" 
  text="Heh. Wrong."
  animation="spin-and-pulse">

  <div>
   Playing 100 times doesn't change the fact that 4 coins with 20% probability has the lower expected value.
  </div>

  <buton @click="set('100-chart')">Next</buton>
</avatar>

<centered key="100-chart"
  v-if="show('100-chart')">
  <div>
  Running a simulation where a computer really executes the 4 coins with 20% probability deal 100 times, yields... (chart)
  </div>
  
  <div>
    We see the average result is near 80, although random variation resulted in totals near 60 and 100. But in __% of casses, taking the guaranteed 100 coins would have been a better choice.
  </div>

  <div>
    This is a sneak peak of the Binomial Distribution which you will see later in this adventure. Statisticians have invented distributions to model many common scenarios. 
  </div>

  <buton @click="set('congrats')">Stats is cool</buton>
</centered>

<centered key="congrats"
  v-if="show('congrats')">
  <div style="font-size: 48px; letter-spacing:4px;">
  CONGRATS
  </div>
  
  <ul>
    <li>You learned about expected value (the average)</li>
    <li>You got a sneak peak of the usefulness statistical distributions</li>
  </ul> 

  <buton @click="finish()">Next section</buton>
</centered>

<!--</transition> -->
</div>
</script>


<!-- begin templates -->
<script type="text/x-template" id="interstitial-template">
<centered>
   <div class="cropcircle" style="margin:0 auto; margin-bottom:16px" :style="cropCircleStyle"></div>
  <slot></slot>
</centered>
</script>


<script type="text/x-template" id="centered-template">
<div class="centered">
  <div class="centered-content"><slot></slot></div> 
</div>
</script>

<script type="text/x-template" id="bold-template">
<span class="bold"><slot></slot></span> 
</script>

<script type="text/x-template" id="histogram-template">
<div>
<svg :width="chartWidth+margin.left+margin.right" 
     :height="chartHeight+margin.top+margin.bottom">
    <g v-if="isCreated" 
      class="container"
      :transform="'translate(' + margin.left + ',' + margin.top + ')'">
      <rect v-for="(arr, bin) in hist.bins"
          :x="hist.xScale(bin)"
          :y="chartHeight - hist.yScale(arr.length)"
          :width="hist.xScale.bandwidth()"
          :height="hist.yScale(arr.length)"
          :key="bin"
          fill="#E9BE2B"/>

      <text v-for="(arr, bin) in hist.bins" 
        :x="hist.xScale(bin)+12"
        :y="chartHeight - hist.yScale(arr.length) - 2">
        {{ label(arr) }}
      </text>
    </g>
</svg>
</div>
</script>


<script type="text/x-template" id="avatar-template">
<div style="position: relative; width:600px; margin:0 auto; margin-top:16px">

<!--
<transition name="slide-fade">
 <div v-if="showOverlay && hasSlot('overlay')"
     style="position:absolute; z-index:1; height: 500px; width:100%; opacity:0.9; background-color: white; color:black;">
  <centered>
      <slot name="overlay"></slot>
  </centered>
</div>
</transition> -->


<img v-if="showRainbow" src="images/rainbow.png">

<img :src="imgSrc" 
     :class="imgClasses"
     style="height: 300px; left: 0px; position:absolute; top:0px;">

<!-- Dialog box -->
<div style="position:absolute; left: 200px; top:0px;"
  v-if="showLiveText">
  <img src="images/dialog.png" >
  <div style="position: absolute; left:40px; top:23px;" class="dialog-text"
  ref="test"
  :class="dialogClass">
    <live-text  
        ref="initial-text"
        key="initial-text"
        v-if="!showNewText" @live-text-complete="showQuestion=true">
        <slot name="dialog"></slot>
      {{text}}
    </live-text> 

    <live-text 
        key="new-text"
        v-if="showNewText"
        @live-text-complete="showNewQuestion=true">
        <slot name="new-text"></slot>
    </live-text>
  </div>
</div>

<!-- Mini dialog -->
<div v-if="showMiniDialog" style="position:absolute; left: 100px; top:300px;">
  <img src="images/mini_dialog.png" style="width:150px">
  <div style="position: absolute; left:40px; top:40px;" class="small-dialog-text">
    Yep!
  </div>
</div>

<!-- Bottom right -->
<div class="question" style="position:absolute; left: 0px; top: 300px; width: 600px; text-align:right">

  <!-- Show hint via nopeText or nope slot -->
  <transition name="fade">
    <div v-if="nopeText" 
         class="nope" style="margin-top:24px">{{nopeText}}</div>
<!--    <div v-if="showHint" class="nope">
      <slot name="hint"></slot>
    </div> -->
  </transition>


<transition name="fade" mode="out-in">  
  <div v-if="showQuestion && !showNewQuestion">  
    <slot></slot>
  </div>

  <slot v-if="showNewQuestion" name="new-question"></slot>
</transition>
</div>

<!-- Cop overlay -->
<transition name="slide-up">
<div v-if="showCop" style="position:absolute; top: 200px; left:0px;" @click="showCop=false">
  <img src="images/cop.png" >
  <div style="position:absolute; left: 200px; top:0px">
    <img src="images/up_dialog.png" style="height: 500px">
    <div class="small-dialog-text" style="position:absolute; left:0px; top:0px; padding:28px">

      <div v-if="showHint">
        <slot name="hint"></slot>
      </div>

    <div class="handwriting" style="position:absolute; left:28px; top:360px; font-size:12px">Click to dismiss</div>
  </div>
</div>
</div> 
</transition>

</div>
</script>



<script type="text/x-template" id="story-template">
<div v-if="isVisible"><slot></slot></div>
</script>

<script type="text/x-template" id="live-text-template">
  <div>
    <transition-group name="fade" tag="span">
      <span v-for="(token, i) in visibleTokens" :key="i" v-html="token">
      </span>
    </transition-group>
  </div>
</script>


<script type="text/x-template" id="monk-head-template">
<div class="handwriting normal-div"
      style="display:inline-block; position:relative; white-space: nowrap;">
  <img src="images/monk_head.png" style="width:80px;">

  <!-- speech pointing to left -->
  <div v-if="hasSlot('lhs')">
    <div style="width:22px; border:1px solid black; transform:rotate(50deg); position:absolute; top:-14px; left:10px;"></div>
    <div style="position:absolute; top: -40px; left:0px;">
      <slot name="lhs"></slot>
    </div>
  </div>

  <!-- speech pointing to right -->
  <div v-if="hasSlot('rhs')">
    <div style="width:24px; border:1px solid black; transform:rotate(310deg); position:absolute; top:-14px; left:50px;"></div>
    <div style="position:absolute; top: -40px; left: 60px;">
      <slot name="rhs"></slot>
    </div>
  </div>

</div>
</script>

<script type="text/x-template" id="exp-template">
<var>{{base}}<sup>{{pow}}</sup></var>
<!--<span>{{base}}<sup>{{pow}}</sup></span>-->
</script>


<script type="text/x-template" id="frac-template">
<var><sup>{{num}}</sup>&frasl;<sub>{{den}}</sub></var>
</script>

<script type="text/x-template" id="buton-template">
<span style="margin-bottom:0px; position:relative; display:inline-block">
  <div v-if="showX" 
       class="handwriting" 
       style="display:inline-block; position:absolute; color:red; font-size: 64px; left: calc(50% - 20px); top:-4px">X</div>
  <button @click="butonClicked()" v-on="$listeners" :class="{'rainbow-text': showRainbowText, 'clicked-button': clickedButton}" class="handwriting"><slot></slot>
  </button>
<!--  <transition name="fade">
    <div v-if="showNopeText" class="nope" style="margin-bottom:8px; position:relative; top:-4px;">
      {{nope}}
    </div>
  </transition>-->
</span>
</script>


<script type="text/x-template" id="input-box-template">
  <div style="display:inline-block; position:relative;">
    <input v-model="val" placeholder="?" style="width:50px; display:inline" v-on:keyup.enter="answerSubmit">
    <buton style="display:inline" @click="answerSubmit">Go</buton>
  
    <transition name="fade">
      <span v-if="showFeedback" class="nope" style="position:absolute; bottom: -8px; margin-bottom:0px" :style="feedbackStyle">
        {{feedbackString}}
      </span>
    </transition>
  </div>
</script>


<!-- end templates -->


<script>

const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
// https://alligator.io/vuejs/global-event-bus/
const bus = new Vue();


const store = new Vuex.Store({
  state: {
    flipStringHeight: 20,
  },
  // sync // store.commit('name', payload)
  mutations: {
    flipStringHeight(state, height){
      state.flipStringHeight = height;
    },
  },
  // async  // state.dispatch('name', payload);
  actions: {
  }, 
  // Put shared logic 
  getters: {
  }
});


var sounds = {
  'coin': {clip: new Audio('sounds/gold1.wav')},
  'heads': {clip: new Audio('sounds/gold0.wav')},
  'tails': {clip: new Audio('sounds/gold1.wav')},

  'speech': {clip: new Audio('sounds/speech_louder.wav')},
  'buton': {clip: new Audio('sounds/button.wav')},
  'wrong': {clip: new Audio('sounds/wrong.wav')},
  'chimes': {clip: new Audio('sounds/chimes.wav')},
  // 'right': {clip: new Audio('sounds/right_soft.wav'), duration: 1000},
  'glitch': {clip: new Audio('sounds/glitch.wav')},
  'spell': {clip: new Audio('sounds/spell.wav')},
  'coy': {clip: new Audio('sounds/laugh.wav')},
  'right': {clip: new Audio('sounds/swish1.wav')},
  'curious': {clip: new Audio('sounds/curious.wav')},
  'achievement': {clip: new Audio('sounds/achievement.wav')},
};

// pull the dialog into a new component?? 
const copIntro = {
  'trainee': {
    dialog: "Hey! You're the new trainee, right?",
    buttons: ['Er...', 'Yes'],
  },
'honor': {
    dialog: "I still remember my first day with the Statistics Police... What an honor to be chosen to help people with their statistics problems.",
    buttons: ['Next'],
  },
'understaffed': {
    dialog: "Anyways, I'm glad you're here. We are massively understaffed. And there are reports of some mysterious --",
    buttons: ['Chase'],  
  }
};

Vue.component('intro-scene', {
  data: function(){
    return {
      stateInd: 0,
      showButons: false,
      showCop: true,
      showDialog: true,
      showWizard: false,
      showMonster: false,
      showExclamation: false,
      states: ['trainee', 'honor', 'understaffed', 'chase', 'fin'],
      wizardImg: 'wizard_run.png',
      narration: '',
    }
  },
  computed: {
    state: function(){
      return this.states[Math.min(this.stateInd, this.states.length-1)];
    },
    copDialog: function(){
      if (copIntro[this.state]){
        return copIntro[this.state].dialog;        
      }
    },
    butonValues: function(){
      if (copIntro[this.state]){
        return copIntro[this.state].buttons;        
      }
      return ['Next'];
    },
  },
  mounted: async function(){
    // await wait(100);
    // this.$refs['cop'].style.left = 'calc(50% - 50px)';
    // await wait(3000);
    // this.$refs['cop'].classList.remove('walk-bounce');
  },
  methods: {
    advance: async function(){
      console.log('advancing from: ' + this.state);
      this.showButons = false;
      this.stateInd++;
      if (this.state == 'chase'){
        this.showCop = false;
        this.showMonster = true;
        this.showWizard = true;
        // Wizard runs to the middle
        this.$refs['wizard'].classList.remove('walk-drift');
        this.$refs['wizard'].style.left = '0%';
        await wait(100);
        this.$refs['wizard'].classList.add('walk-drift');
        this.$refs['wizard'].style.left = '60%';
        // Wizard casts spell.
        await wait(1500);
        this.wizardImg = 'wizard.png';
        this.$root.play('spell');  
        // Monster begins to glitch.
        this.$refs['monster'].glitch();
        this.$refs['girl'].glitch();

        // Wizard runs off.
        await wait(800);      
        this.wizardImg = 'wizard_run.png';
        this.$refs['wizard'].style.left = '105%';
        await wait(1500);
        this.narration = 'The mysterious figure cast a spell! The victims are now fuzzy.';

        await wait(1500);
        this.showButons = true;
      } 
      if (this.state == 'fin'){
        this.$root.nextStory();
        // this.$emit('scene-complete');
      }
    },
    liveTextComplete: async function(){
      if (this.state == 'understaffed'){
        await wait(500);
        this.showExclamation = true;
 
        await wait(200);
        // this.showDialog = false;
        this.showWizard = true;
        // https://michaelnthiessen.com/force-re-render
        // this.$nextTick(() => {
        //   debugger;
        //   this.$refs['wizard'].style.left = '105%';
        // });
        await wait(100);
        this.$refs['wizard'].style.left = '105%';
        await wait(2000);
      } 

      if (this.state in copIntro){
        this.showButons = true;
      }
    },
  },
  template: '#intro-scene-template'
});

Vue.component('coin', {
  props: {
    bias: {type: Number, default: 0.5},
    pattern: {type: String},
  },
  data: function(){
    return {
      flips: [true, false, true, true], 
    }
  },
  computed: {
    flipString: function(){
      return this.flips.map(this.render).join('');
    },
    flipStringStyle: function(){
      return { 'min-height': store.state.flipStringHeight + 'px'};
    },
    isShowingH: function(){
      if (this.flips.length == 0){
        return true;
      }
      return this.render(this.last) == 'H';
    },
    last: function(){
      return this.flips[this.flips.length-1];
    },
    hist: function(){
      const xScale = d3.scaleBand()
          .domain(['H', 'A']).paddingInner(.1).range([0, 100]);

      // Why would this happen?
      // histogram([false, true, false, true, false, false])
      // Probably because d3 adaptive bins.
      // (5) [Array(4), Array(0), Array(0)], Array(0), Array(2)]
      // const histogram = d3.histogram()
      //   .domain(xScale.domain());

      // const bins = histogram(this.flips);

      const bins = _.groupBy(this.flips.map(this.render));
      const counts = _.map(_.values(bins), arr => arr.length);
      // const pcts = _.map(counts, x => this.$root.formatPct(x / _.sum(counts)));
      const yScale = d3.scaleLinear()
          .domain([0, _.sum(counts)]).range([0, 80]);
      return {
        xScale: xScale,
        yScale: yScale,
        bins: bins,
      };
    },
  },
  watch: {
    flipString(){
      const height = this.$refs['flip-string'].clientHeight;
//      console.log('height: ' + height);
      if (height > store.state.flipStringHeight){
        console.log('updating height to: ' + height);
//        store.commit('flipStringHeight', height);
      }
    }
  },
  methods: {
    render: function(flip){
      return flip ? 'H' : 'A';
    },
    append: function(flip){
      this.$root.play(flip ? 'heads' : 'tails');
      this.flips.push(!!flip);
    },
    reset: function(){
      this.flips = [];
    },
    flip: function(){
      // Always repeats as HAHA.
      if (this.pattern == 'haha'){
        if (this.flips.length == 0){
          this.append(1);
        } else {
          this.append(Math.abs(this.last - 1));
        }

        // Early return.
        return;
      }

      // Prevents long streaks from happening.
      if (this.pattern == 'human'){
        const maxStreak = 3;
        if (this.flips.length > maxStreak){
          const slice = this.flips.slice(-maxStreak);
          if(_.every(slice) || _.every(slice, x => !x)){ 
            // If the last ones have all been of a type, the new one must be opposite.
            this.append(Math.abs(this.last - 1));
          } 

          // Fallthrough.
        }
      }

      // True coin flip.
      this.append(Math.random() < this.bias); 
    }
  },
  template: '#coin-template'
});

Vue.component('biased-coin-machine', {
  data: function(){
    return {
      slider: '50',
    }
  },
  computed: {
    bias: function(){
      return +this.slider / 100;
    },
  },
  watch:{
    bias: function(){
      this.$refs['coin'].reset();
    },
  },
  template: '#biased-coin-machine-template'
});

// You're the trainee right?
// This causes the buttons to show up
// User clicking the buton advances the state -- 
Vue.component('glitch', {
  props: {
    start: {type: String},
    end: {type: String},
  },
  data: function(){
    return {
      showStart: true,
    }
  },
  methods: {
    glitch: async function(){
      await wait(1000);
      this.showStart = false;
      this.$root.play('glitch');
      await wait(200);
      this.showStart = true;
      await wait(200);
      this.showStart = false;
      this.$root.play('glitch');
      await wait(200);
      this.showStart = true;
      await wait(200);
      this.showStart = false;
      this.$root.play('glitch');
    }
  },
  template: '#glitch-template'
});


Vue.component('note', {
  props: {
    title: {type: String},
  },
  template: '#note-template'
});

Vue.component('input-box', {
  props: {
    right: {type: Number, default: 0},
    hints: {
      type: Array, 
      default: function(){ return ['Try again', 'Nope']; },
    },
    onRight: {
      type: Function,
      default: function(){},
    },

    // Default to no feedback bc avatar takes care of it, but sometimes we want to use this as a standalone component.
    feedback: {type: Boolean, default: false},
  },
  computed: {
    feedbackString: function(){
      if (this.isYay){
        return 'Yay!';
      }
      return this.hints[this.numWrong % this.hints.length];
    },
    feedbackStyle: function(){
      return {'color': this.isYay ? 'green' : 'red'};
    },
    isYay: function(){
      return this.val == this.right;
    },
    isNope: function(){
      return !this.isYay;
    }
  },
  data: function(){
    return {
      val: null,
      showFeedback: false,
      numWrong: 0,
    }
  },
  methods: {
    answerSubmit: async function(){
      if (this.feedback){
        this.showFeedback = true;
        await wait(500);
      }

      bus.$emit('answer-submitted', this);
      // look at the value in the input.
      if (this.isYay){
        await wait(1000);
        this.onRight();
      } else {
        this.numWrong++;
      }

    }
  },
  template: '#input-box-template'
});


function firstAncestorOfComponent(node, componentName){
  while(node !== undefined){
    node = node.$parent;
    if (node !== undefined && node.$options.name === componentName){
      return node;
    }
  }
  return undefined;
}
function isDescendant(ancestor, maybeChild){
  var node = maybeChild.$parent;
  while(node !== undefined){
    if (node === ancestor){
      return true;
    }
    node = node.$parent;
  }
  return false;
}
Vue.component('avatar', {
  props: {
    image: {type: String}, // 'girl.png'
    text: {type: String, default: ''},
    animation: {type: String, default: 'wobble'},
    sound: {type: String},
  },
  data: function(){
    return {
      showQuestion: false,
      showNewQuestion: false,
      showMiniDialog: false,
      showLiveText: false,
      showHint: false,
      showRainbow: false,
      showFall: false,
      showNewText: false,
      reactionImage: null,
      nopeText: null,
      showCop: false,
    };
  },
  mounted: async function(){
    // Add a blink
    var this_ = this;
    if (this.sound){
      this.$root.play(this.sound);
      await wait(sounds[this.sound].duration || 500);
    }
    await wait(500);
    this_.showLiveText = true;
    bus.$on('avatar-react', function(params){
      this_[params.key] = params.value;
    });
    bus.$on('answer-submitted', function(input){
      this_.reactToInput(input);
    });
    // setInterval(async function(){
    //   // change it to the blink
    //   console.log('blinking');
    //   this_.reactionImage = 'monster_blink.png';
    //   await wait(100);
    //   this_.reactionImage = null;
    // }, 3000);
  },
  computed: {
    imgClasses: function(){
      var classes = {fallover: this.showFall};
      classes[this.animation] = true;
      return classes;
    },
    imgSrc: function(){
      return 'images/'+ (this.reactionImage || this.image);
    },
    dialogClass: function(){
      const maxLen = 140;
      const longText = this.text.length > maxLen;

      // hack. should do this recursively.
      const longSlotText = this.hasSlot('dialog') && this.$slots['dialog'][0].text && this.$slots['dialog'][0].text.length > maxLen;

      const longSlotWithEltText = this.hasSlot('dialog') && this.$slots['dialog'][0].children && this.$slots['dialog'][0].children[0].text && this.$slots['dialog'][0].children[0].text.length > maxLen;
      return {'small-dialog-text': longText || longSlotText || longSlotWithEltText};
    }
  },
  methods: {
    hasSlot: function(name){
      return !!this.$slots[ name ] || !!this.$scopedSlots[ name ];
    },
    // For some reason, this need to be a separate fn, rather than inside the bus.
    // when the player clicks on a nope button, if the button has nope text, that is rendered.
    // otherwise, if the avatar has a hint slot that is shown.     
    reactToInput: function(input){
      // when the player clicks on a nope button, if the button has nope text, that is rendered.
      // otherwise, if the avatar has a hint slot that is shown. 
      if (input.nopeText){  
        this.nopeText = input.nopeText;
//        this.showCop = true;        
      } else if(input.isNope && this.hasSlot('hint')){
        this.showHint = true;
        this.showCop = true;        
      }
    }
  },
  template: '#avatar-template'
});
// Just like a button, but with some special abilities.
// When clicked it looks at it's parent to see if it's a buton-group.
// Executes the onClick event if so.
// e.g.
// <buton-group onClick="doSomethingSecond">
//   <buton @click="doSomethingFirst">Click me</buton>
// </buton-group>
// However, if the buton is a nope buton the buton-group does not get triggered.
// <buton nope="stop and think">Tricked ya</buton>
// <buton nope>Tricked ya</buton>
// Buttons may also have a yay attribute.
// Which causes the button to turn rainbow-text after it gets clicked.
Vue.component('buton', {
  props: {
    nope: {type: String}, // Text for why the answer is wrong. Blocks progression.
    // moved to attr
    //yay: {type: Boolean, default:false}, // Causes cool animation to happen when clicked.
  },
  data: function(){
    return {
      showNopeText: false,
      showRainbowText: false,
      showX: false,
      clickedButton: false,
    }
  },
  computed: {
    nopeText: function(){
      return this.nope;
    },
    // Returns true for: <buton nope> or <buton nope="why not">
    isNope: function(){
      return this.nope || this.nope==="";
    },
    isYay: function(){
      return 'yay' in this.$attrs;
    },
  },
  methods: {
    butonClicked: async function(){
      this.$root.play('buton');
      this.clickedButton = true;
      // Mark the buton as wrong.
      if (this.isNope){
        this.showX = true;
      }
      // Tell those listening on the bus that the buton has been clicked... unless it's a buton within an input-box.
      if(!firstAncestorOfComponent(this, 'input-box')){
        bus.$emit('answer-submitted', this);        
      }
      await wait(1000);
      this.$emit('clik');
      if (!this.isNope && this.$parent.onClick !== undefined){
        // Add delay so any custom handlers on the buton execute before the generic buton-group executes.
        await wait(1000);
        this.$parent.onClick();        
      }
    },
  },
  template: '#buton-template'
});

Vue.component('exp', {
  props: {
    base: {type: String },
    pow: {type: String },
  },
  template: '#exp-template'
});


Vue.component('frac', {
  props: {
    num: {type: String },
    den: {type: String },
  },
  template: '#frac-template'
});


// histogram example
// https://bl.ocks.org/d3noob/96b74d0bd6d11427dd797892551a103c
Vue.component('histogram', {
  props: {
    hist: {type: Object }, // data for constructing the histogram {xScale: yScale: bins: }
    chartHeight: {type: Number, default: 80},
    chartWidth: {type: Number, default: 120},
    margin: {
      type: Object, 
      default: function(){
        return {top: 0, right: 10, bottom: 20, left: 10};
      }
    },
  },
  data: function(){
    return {
      isCreated: false,
    }
  },
  created: function(){
    // Add domains
    // this.hist.xScale.range([0, this.chartWidth]);
    // this.hist.yScale.range([this.chartHeight, 0]);
    this.isCreated = true;
  },
  mounted: function() {
    // Add the axis
    var xAxis = d3.axisBottom(this.hist.xScale); //.ticks(8);
//    var yAxis = d3.axisLeft(this.hist.yScale);

    const chart = d3.select(this.$el).select('.container');
//    chart.append('g').call(yAxis);
    chart.append('g').attr('transform', 'translate(0,' + this.chartHeight + ')').call(xAxis);
  },
  methods: {
    label: function(arr){
      const total = _.sum(_.values(this.hist.bins).map(a => a.length));
//      console.log('length: ' + arr.length + ' total: ' + total);
      return this.$root.formatPct(arr.length / total);
    }
  },
  template: '#histogram-template'
});


Vue.component('buton-group', {
  props: {
    onClick: {type: Function, 
              default: () => console.warn('buton-group should have onClick') },
  },
  template: '<div><slot></slot></div>'
});
Vue.component('centered', {
  template: '#centered-template'
});
Vue.component('bold', {
  template: '#bold-template'
});
Vue.component('interstitial', {
  props: {
    image: {type: String, default: 'monster.png'}, 
  },
  computed: {
    cropCircleStyle: function(){
      return {'background-image': 'url("images/' + this.image + '")'};
    }
  },
  mounted: function(){
    this.$root.play('chimes');
  },
  template: '#interstitial-template'
});
function makeComponent(componentName, points, reactions){
  var reactions = reactions || {};
  Vue.component(componentName, {
    data: function(){
      return {
        active: 'intro',
        lastActive: 'intro',
        points: points, // jump points in the story
        problemToCorrectness: {}, // 'fakeout1': [false, true]
        memory: null, // A variable for dumping short term component state.
      };
    },
    computed: {
      activeOrLastKnownPoint: function(){
        if (this.isKnownPoint(this.active)){
          return this.active;
        }  
        return this.lastActive;
      }
    },

    mounted: async function(){
      var this_ = this;
      bus.$on('answer-submitted', async function(input){
        // Respond only if the input is within the current component.
        if (!isDescendant(this_, input)){
          return;
        }
        // Have avatar react based on buton attributes.
        var avatar = firstAncestorOfComponent(input, 'avatar');
        if (!avatar){
          // The buton was not used within an avatar, but something else.
          return;
        }
        var problemKey = avatar.$vnode.data.key;
        // If there's a yay.
        if (input.isYay){
          avatar.reactionImage = reactions.yay;
          this_.addCorrectness(problemKey, true);          
          // If the user got it on their first try, show a rainbow.
          if (this_.perfect(problemKey)){
            this_.react('showRainbow', true);
          }
        }
        
        // just a naked <buton nope>
        if (input.isNope){
          avatar.reactionImage = reactions.nope;
          this_.addCorrectness(problemKey, false);  
        } 
        if ('coy' in input.$attrs){
          avatar.reactionImage = reactions.coy;
          this_.$root.play('coy');
        }
      });
    },
    methods: {
      addCorrectness(key, isCorrect){
        if(!(key in this.problemToCorrectness)){
          this.problemToCorrectness[key] = [];
        }
        this.problemToCorrectness[key].push(isCorrect);
      },
      isKnownPoint: function(point){
        return points && points.map(d => d.key).indexOf(point) > -1;
      },
      react: function(k, v){
        bus.$emit('avatar-react', {key: k, value: v});
      },
      print: function(thing){
        console.log(thing);
      },
      show: function(key){
//        return true;
        return key == this.active;
      }, 
      got: function(key){
        // Return the latest value
        if (this.problemToCorrectness[key]){
          var answers = this.problemToCorrectness[key];
          return answers[answers.length-1];
        } else {
          console.warn('checking for correctness of ' + key + ' which did not exist');
          return false;
        }
      },
      set: async function(key, optionalDelay){
        // Only update the lastActive point if the point is a known point.
        if (this.isKnownPoint(this.active)){
          this.lastActive = this.active;          
        }
        console.log('setting: ' + key);
        if (optionalDelay !== undefined){
//          console.log('started waiting');
          await wait(optionalDelay);        
 //         console.log('done waiting');
        }
        this.active = key;
      },
      delay: async function(fn, ms){
        await wait(ms);
        fn();
      },
      perfect: function(key){
        // All answers to this problem were correct.
        if(this.problemToCorrectness[key] && _.every(this.problemToCorrectness[key])){
          return true;
        }
        return false;
      },
      pointStyle: function(point){
        var style = {};
        if (this.perfect(point.key)){
          style['background-image'] = "url('images/rainbow.png')";
          style['background-size'] = 'cover';
        }
        return style; 
      },
      pointClass: function(point){
        return {
          'active-point': point.key == this.activeOrLastKnownPoint,
          'circle': point.problem
        };
      },
      finish: async function(){
        this.$root.play('achievement');
        await wait(1500);
        this.$root.nextStory();
      }
    },
    template: '#' + componentName + '-template'
  });
}
// Joint prob with independence
makeComponent('intro-scene');
makeComponent('coin-flips', 
[
  { key: 'intro', name: 'Intro', },
  { key: 'HH', name: 'Probability of 2 heads', problem: true},
  { key: 'HHH', name: 'Probability of 3 heads', problem: true},
  { key: '10H', name: 'Probability of 10 heads', problem: true},
  { key: '10HT', name: 'Probability of 10 heads and tails', problem: true},
  { key: 'HHHHH', name: '5 heads', problem: true},
  { key: '100H', name: '100 heads', problem: true},
  { key: 'quest', name: 'Quest', },
],
{
  'yay': 'monster_yay.png',
  // 'nope': 'monster_cry.png'
}
);

makeComponent('wizard-flips',
[
  { key: 'intro', name: 'Intro', },
  { key: '3coins', name: '3 coins', problem: true},
  { key: 'interactive', name: 'Play with biased coin', },
  { key: '3coins2', name: '3 more coins', problem: true},
  { key: '3coins3', name: 'Final 3 coins ', problem: true},
  { key: 'fin', name: 'fin', },
]); 

// Conditional prob + join prob with chain rule
makeComponent('chain-rule', [
  { key: 'intro', name: 'Intro', },
  { key: 'fakeout1', name: 'Independence', problem: true},
  { key: 'conditional1', name: 'Conditional probability', },
  { key: 'tall-hair', name: 'P(tall AND great hair)', problem: true},
  { key: 'fakeout2', name: 'Tattoos', problem: true},
  { key: 'chainruleinter1', name: 'Chain Rule', },
  { key: 'problem3', name: 'P(tall AND great hair AND tattoos)', problem: true},
  { key: 'problem4', name: 'They need to be single', problem: true},
  { key: 'mind-blown', name: 'Mind blown', },
  { key: 'congrats', name: 'Congrats', },
  ],
{
    'yay': 'girl_happy.png',
    // 'nope': 'girl_upset.png',
    // 'coy': 'girl_coy.png'
}
); 
// EV
makeComponent('risk-reward', [
  { key: 'intro', name: 'Intro', },
  { key: 'ev', name: 'EV', },
  { key: '100', name: 'EV 100', },
  { key: '100-chart', name: 'Binomial distribution', },
  { key: 'congrats', name: 'Congrats', },
]); 
// Can be used to delay logic
// <delay></delay>
Vue.component('delay', {
  props: {
    ms: {type: Number, default: 500},
    visible: {type: Boolean, default: false},
  },
  data: function(){
    return {
      shouldTrigger: false,
    }
  },
  computed: {
    compStyle: function(){
      if (this.visible){
        return {};
      } else {
        return {'display': 'none'};
      }
    }
  },
  mounted: function(){
    var this_ = this;
    setTimeout(function(){
      this_.shouldTrigger = true;
    }, this.ms);
  },
  template: `<span v-if="shouldTrigger" style="compStyle"><slot></slot></span>`,
});
// Hides content until it is revealed as part of the story.
Vue.component('story', {
  props: {
    visible: {type: Boolean, default:false},
  },
  data: function(){
    return {
      isVisible: this.visible,
    };
  },
  watch: {
    isVisible: scrollWindow,
  },
  template: '#story-template'
});
/*
How should this work:
- split the text into words
- inject the words in via setinterval
- add a transition component that makes it fade in when it is injected
*/
Vue.component('live-text', {
  props: {
    interval: {type: Number, default: 1000},
  },
  render: function (createElement) {
    var data = [];
    for (var i=0; i<this.$slots.default.length; i++){
      var vnode = this.$slots.default[i];
      if (vnode.tag){
        data.push([vnode.tag, vnode.data, vnode.children]);
      } else if (vnode.text){
        var tokens = vnode.text.split(' ').filter(token => token);
        data = _.concat(data, tokens.map(token => ['span', {}, token + ' ']));
      }
    }
    var vnodes = data.map(function(tuple, i){
      const tag = tuple[0];
      const nodeData = tuple[1];
      const children = tuple[2];
      const meta = {
        ref: i, 
        class: { 'hidden-at-first': true }
      };
      return createElement(tag, _.merge(meta, nodeData), children);
    });
    return createElement(
      'div',   // tag name
      vnodes, 
    )
  },
  data: function(){
    return {
      visibleTokens: [],
      length: 0,
    };
  },
  mounted: function(){
    console.log('mounting live text');
    this.animate();
  },
  methods: {
    animate: async function(){
      var elts = _.values(this.$refs);

      this.length = _.sum(elts.map(elt => elt.textContent.length));

      function pauseDuration(text){
        const short = 100;
        const med = 500;
        const long = 1000;
        if (!text){
          return short;
        }
        if (text.includes('.') || text.includes('?') || text.includes('!')){
          return long;
        }
        if (text.includes(')')){
          return med;
        }
        return short;
      }
      this.$root.play('speech');
      for (var i=0; i<elts.length; i++){
        var elt = elts[i];
        elt.style.opacity = 1;
        // Pause.
        var duration = pauseDuration(elt.textContent);
        if (duration == 1000){
          this.$root.pause('speech');
        }
        await wait(duration);
        if (duration == 1000){
          this.$root.play('speech');
        }
      }
      this.$root.pause('speech');
      this.$emit('live-text-complete');
    },
  },
  template: '#live-text-template'
});
// <intro-scene key="intro" v-if="show('intro')" @scene-complete="set('intro1')">
// </intro-scene>
var storyPoints = [
{
  name: 'Intro',
  component: 'intro-scene',
  image: 'scroll.png',
},
{
  name: 'Coin Flips',
  component: 'coin-flips',
  image: 'monster.png',
  color: '#82A81D',
},
{
  name: 'Bad Wizard',
  component: 'wizard-flips',
  image: 'wizard.png',
  color: '#E9BE2B',
},
{
  name: 'Chain Rule',
  component: 'chain-rule',
  image: 'girl.png',
  color: '#0082B6',
},
// {
//   name: 'Risk Reward',
//   component: 'risk-reward',
//   image: 'bear.png',
// },
];
// Gotchas:
// DOM does not update for new property additions.
// DOM does not update for direct assignments within arrays.
// https://vuejs.org/2016/02/06/common-gotchas/#Why-isn%E2%80%99t-the-DOM-updating  
new Vue({
  el: '#app',
  data: {
    storyPoints: storyPoints,
    storyPointInd: 0,
    // Obj property additions do not update DOM, so prepopulate all the keys in the object. Or use lists.
    //soundNameToCount: {},
    show: false,
    isPlaying: false,
  },
  computed: {
    currentStoryPoint: function(){
      return this.storyPoints[this.storyPointInd];
    }
  },
  // watch: {
  //   currentStoryPoint: function(){
  //     this.$root.play('swish');
  //   },
  // },
  methods: {
//    show: show, 
    formatPct: formatPct,
    // round_to(2.777777, 0) -> 3
    // round_to(2.777777, 2) -> 2.78
    roundTo: roundTo,
    nextStory: async function(){
      // this.play('achievement');
      // await wait(1500);
      this.storyPointInd = Math.min(this.storyPoints.length-1, this.storyPointInd+1);
    },
    // // Given 0.8 --> returns {}
    // paramsFromCertainty: function(certainty){
    //   if (certainty == 1.0){
    //     return {
    //       numLoseIfWrong: 10000000, 
    //       numWinIfRight: 1,
    //       certainty: certainty,
    //       percent: '100%',
    //     };
    //   }
    //   return {
    //     numWinIfRight: 1, 
    //     numLoseIfWrong: this.roundTo(certainty/(1-certainty), 1),
    //     certainty: certainty,
    //     percent: this.formatPct(certainty)
    //   };      
    // },
    // paramsFromBet: function(num_win_if_right, num_lose_if_wrong){
    //   var certainty = num_lose_if_wrong/(num_win_if_right+num_lose_if_wrong);
    //   return this.paramsFromCertainty(certainty);
    // },
    play: function(soundName){
//      console.log('playing ' + soundName);
      var sound = sounds[soundName].clip;
      sound.play().catch(function(error){
        console.log(error.toString());
//        debugger;
      });    
    },
    pause: function(soundName){
 //     console.log('pausing');
      var sound = sounds[soundName].clip;
      sound.pause();
      sound.currentTime = 0;      
    }
  } // end methods
});
</script>